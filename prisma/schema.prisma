// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Enums
// ============================================

enum UserType {
  individual
  admin
  member
}

// 個人プラン
enum IndividualPlan {
  free
  starter
  pro
  max
}

// 組織プラン
enum OrganizationPlan {
  free
  starter
  business
  enterprise
}

enum SubscriptionStatus {
  active
  canceled
  past_due
}

enum AccessKeyStatus {
  active
  used
  expired
  revoked
}

enum ChatMode {
  explanation
  generation
  brainstorm
}

enum LearningType {
  insight
  reflection
}

enum GenerationStatus {
  idle
  generating
  completed
  failed
}

enum ProjectStatus {
  planning // 企画中
  in_progress // 進行中
  completed // 完了
  archived // アーカイブ
}

enum TaskStatus {
  pending // 未着手
  in_progress // 進行中
  completed // 完了
  blocked // ブロック中
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

// クレジット購入ステータス
enum CreditPurchaseStatus {
  pending
  completed
  failed
  refunded
}

// クレジット割り振りリクエストステータス
enum CreditAllocationRequestStatus {
  pending
  approved
  rejected
}

// プロジェクトタイプ
enum ProjectType {
  product // プロダクト開発
  learning // 学習プロジェクト
}

// プロダクトPJのフェーズ
enum ProjectPhase {
  planning // 企画フェーズ
  design // 設計フェーズ
  development // 開発フェーズ
}

// アーティファクトタイプ
enum ArtifactType {
  code
  component
  config
}

// ============================================
// Models
// ============================================

model Organization {
  id        String           @id @default(uuid())
  name      String
  plan      OrganizationPlan @default(starter)
  settings  Json? // OrganizationSettings
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  // Relations
  users         User[]
  accessKeys    AccessKey[]
  subscription  Subscription?
  creditBalance CreditBalance?

  @@map("organizations")
}

model User {
  id             String    @id @default(uuid())
  email          String?   @unique
  passwordHash   String?   @map("password_hash")
  displayName    String    @map("display_name")
  userType       UserType  @default(individual) @map("user_type")
  organizationId String?   @map("organization_id")
  emailVerified  DateTime? @map("email_verified")
  settings       Json? // UserSettings
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  organization  Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  accessKey     AccessKey?     @relation("AccessKeyUser")
  conversations Conversation[]
  learnings     Learning[]
  tokenUsage    TokenUsage[]
  subscription  Subscription?
  accounts      Account[]
  sessions      Session[]
  projects      Project[]
  artifacts     Artifact[]
  creditBalance CreditBalance?

  @@index([organizationId])
  @@map("users")
}

// NextAuth.js Models
model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model AccessKey {
  id              String          @id @default(uuid())
  organizationId  String          @map("organization_id")
  keyCode         String          @unique @map("key_code")
  userId          String?         @unique @map("user_id")
  dailyTokenLimit Int             @map("daily_token_limit")
  settings        Json? // AccessKeySettings
  expiresAt       DateTime?       @map("expires_at")
  usedAt          DateTime?       @map("used_at")
  status          AccessKeyStatus @default(active)
  createdAt       DateTime        @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation("AccessKeyUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, status])
  @@map("access_keys")
}

model Conversation {
  id               String           @id @default(uuid())
  userId           String           @map("user_id")
  mode             ChatMode
  title            String?
  messages         Json // Message[]
  tokensConsumed   Int              @default(0) @map("tokens_consumed")
  metadata         Json? // ConversationMetadata
  // Generation status tracking
  generationStatus GenerationStatus @default(idle) @map("generation_status")
  pendingContent   String?          @map("pending_content") @db.Text
  generationError  String?          @map("generation_error")
  // Project-centric fields
  projectId        String?          @map("project_id")
  isOrganized      Boolean          @default(false) @map("is_organized")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  learnings Learning[]
  artifacts Artifact[]

  @@index([userId, createdAt])
  @@index([userId, generationStatus])
  @@index([projectId])
  @@index([userId, isOrganized])
  @@map("conversations")
}

model Learning {
  id             String       @id @default(uuid())
  userId         String       @map("user_id")
  conversationId String?      @map("conversation_id")
  projectId      String?      @map("project_id")
  content        String       @db.Text
  sourceMessage  String?      @map("source_message") @db.Text
  memo           String?      @db.Text
  tags           String[]
  type           LearningType @default(insight)
  createdAt      DateTime     @default(now()) @map("created_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  project      Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([projectId])
  @@map("learnings")
}

model TokenUsage {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  date       DateTime @db.Date
  tokensUsed Int      @default(0) @map("tokens_used")
  breakdown  Json? // TokenBreakdown
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("token_usage")
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String?            @unique @map("user_id")
  organizationId       String?            @unique @map("organization_id")
  // 個人プラン（userIdがある場合）
  individualPlan       IndividualPlan?    @map("individual_plan")
  // 組織プラン（organizationIdがある場合）
  organizationPlan     OrganizationPlan?  @map("organization_plan")
  status               SubscriptionStatus @default(active)
  // トライアル期間の終了日（null = トライアルなし or 終了済み）
  trialEnd             DateTime?          @map("trial_end")
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  stripeCustomerId     String?            @map("stripe_customer_id")
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  stripePriceId        String?            @map("stripe_price_id")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  // Relations
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Project {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  title           String
  description     String?       @db.Text
  status          ProjectStatus @default(planning)
  // Project-centric fields
  projectType     ProjectType   @default(product) @map("project_type")
  currentPhase    ProjectPhase? @map("current_phase")
  planningDocUrl  String?       @map("planning_doc_url")
  managementSheet Json?         @map("management_sheet")
  // 企画情報（壁打ちモードからの引き継ぎ）
  ideaSummary     String?       @map("idea_summary") @db.Text
  targetPersona   String?       @map("target_persona") @db.Text
  competitors     String[]
  techStack       String[]      @map("tech_stack")
  mvpFeatures     String[]      @map("mvp_features")
  // 見積もり情報
  estimatedHours  Int?          @map("estimated_hours") // 総見積もり時間（時間単位）
  actualHours     Int?          @map("actual_hours") // 実績時間（時間単位）
  startDate       DateTime?     @map("start_date")
  dueDate         DateTime?     @map("due_date")
  completedAt     DateTime?     @map("completed_at")
  metadata        Json?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks         Task[]
  conversations Conversation[]
  learnings     Learning[]

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([userId, projectType])
  @@map("projects")
}

model Task {
  id               String       @id @default(uuid())
  projectId        String       @map("project_id")
  parentTaskId     String?      @map("parent_task_id")
  title            String
  description      String?      @db.Text
  status           TaskStatus   @default(pending)
  priority         TaskPriority @default(medium)
  // 見積もり・実績
  estimatedMinutes Int?         @map("estimated_minutes") // 見積もり時間（分単位）
  actualMinutes    Int?         @map("actual_minutes") // 実績時間（分単位）
  // 作業記録
  startedAt        DateTime?    @map("started_at")
  completedAt      DateTime?    @map("completed_at")
  // 順序とマイルストーン
  order            Int          @default(0)
  isMilestone      Boolean      @default(false) @map("is_milestone")
  dueDate          DateTime?    @map("due_date")
  // メモ・振り返り
  notes            String?      @db.Text
  retrospective    String?      @db.Text // タスク完了後の振り返り
  metadata         Json?
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentTask Task?   @relation("TaskSubtasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subtasks   Task[]  @relation("TaskSubtasks")

  @@index([projectId, status])
  @@index([projectId, order])
  @@index([parentTaskId])
  @@map("tasks")
}

model Artifact {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  userId         String       @map("user_id")

  // コンテンツ
  type           ArtifactType @default(code)
  title          String
  content        String       @db.Text
  language       String?
  version        Int          @default(1)

  // アンロック進捗（埋め込み）
  unlockLevel    Int          @default(0) @map("unlock_level")
  totalQuestions Int          @default(0) @map("total_questions")
  quizHistory    Json?        @map("quiz_history") // QuizHistoryItem[]
  currentQuiz    Json?        @map("current_quiz") // UnlockQuiz or null

  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId, createdAt])
  @@map("artifacts")
}

// ============================================
// JSON Type Definitions (for documentation)
// ============================================

// OrganizationSettings {
//   allowedModes: string[]           // ['explanation', 'generation', 'brainstorm']
//   allowedTechStacks: string[]      // Language/framework restrictions
//   unlockSkipAllowed: boolean       // Allow skipping unlock in generation mode
//   reflectionRequired: boolean      // Require reflection at session end
//   defaultDailyTokenLimit: number   // Default token limit for new keys
// }

// UserSettings {
//   quizEnabled: boolean             // Enable quiz in explanation mode
//   explanationDetail: 'simple' | 'standard' | 'detailed'
//   unlockMethod: 'quiz' | 'explanation' | 'skip'
//   hintSpeed: 'immediate' | '30sec' | 'none'
//   estimationTraining: boolean
// }

// AccessKeySettings {
//   allowedModes: string[]           // Override organization settings
//   allowedTechStacks: string[]
//   unlockSkipAllowed: boolean
// }

// Message {
//   role: 'user' | 'assistant'
//   content: string
//   timestamp: string (ISO8601)
//   metadata: object (quiz answers, code blocks, etc.)
// }

// ConversationMetadata {
//   options: object                  // Mode-specific options
//   state: object                    // Mode-specific state (unlock level, etc.)
// }

// TokenBreakdown {
//   explanation: number
//   generation: number
//   brainstorm: number
// }

// QuizHistoryItem (stored in Artifact.quizHistory) {
//   level: number
//   question: string
//   userAnswer: string
//   isCorrect: boolean
// }

// UnlockQuiz (stored in Artifact.currentQuiz) {
//   level: number
//   question: string
//   options: { label: string; text: string }[]
//   correctLabel: string
//   hint?: string
// }

// ============================================
// Credit System Models
// ============================================

// クレジット残高（個人/組織）
model CreditBalance {
  id             String        @id @default(uuid())
  userId         String?       @unique @map("user_id")
  organizationId String?       @unique @map("organization_id")
  // 現在の残高（ポイント）
  balance        Float         @default(0)
  // 今月使用したポイント（プラン分）
  monthlyUsed    Float         @default(0) @map("monthly_used")
  // 今月購入したポイント使用量
  purchasedUsed  Float         @default(0) @map("purchased_used")
  // 期間管理
  periodStart    DateTime      @map("period_start")
  periodEnd      DateTime      @map("period_end")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("credit_balances")
}

// クレジット購入履歴
model CreditPurchase {
  id                   String               @id @default(uuid())
  userId               String?              @map("user_id")
  organizationId       String?              @map("organization_id")
  // 購入詳細
  packId               String?              @map("pack_id") // プリセットパックID（nullならカスタム金額）
  pointsPurchased      Float                @map("points_purchased")
  amountPaid           Int                  @map("amount_paid") // 円
  unitPrice            Float                @map("unit_price") // 円/pt
  // Stripe
  stripePaymentId      String?              @map("stripe_payment_id")
  stripeSessionId      String?              @map("stripe_session_id")
  // ステータス
  status               CreditPurchaseStatus @default(pending)
  completedAt          DateTime?            @map("completed_at")
  createdAt            DateTime             @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([organizationId, createdAt])
  @@index([stripeSessionId])
  @@map("credit_purchases")
}

// 組織メンバーのクレジット割り当て
model CreditAllocation {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  // 割り当てポイント
  allocatedPoints Float   @map("allocated_points")
  usedPoints      Float   @default(0) @map("used_points")
  // 期間（月単位）
  periodStart    DateTime @map("period_start")
  periodEnd      DateTime @map("period_end")
  // メモ
  note           String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, userId, periodStart])
  @@index([userId, periodStart])
  @@map("credit_allocations")
}

// メンバーからのクレジット割り振りリクエスト
model CreditAllocationRequest {
  id               String                         @id @default(uuid())
  organizationId   String                         @map("organization_id")
  requesterId      String                         @map("requester_id")
  // リクエスト詳細
  requestedPoints  Float                          @map("requested_points")
  reason           String?
  // ステータス
  status           CreditAllocationRequestStatus  @default(pending)
  reviewedBy       String?                        @map("reviewed_by")
  reviewedAt       DateTime?                      @map("reviewed_at")
  rejectionReason  String?                        @map("rejection_reason")
  // 承認時に作成された割り当てID
  allocationId     String?                        @map("allocation_id")
  createdAt        DateTime                       @default(now()) @map("created_at")

  @@index([organizationId, status])
  @@index([requesterId, createdAt])
  @@map("credit_allocation_requests")
}

// ポイント使用履歴
model PointUsage {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  organizationId String?  @map("organization_id")
  conversationId String?  @map("conversation_id")
  // 使用詳細
  model          String   // sonnet or opus
  pointsUsed     Float    @map("points_used")
  // ソース（プラン分か購入分か）
  fromPlan       Boolean  @default(true) @map("from_plan")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([organizationId, createdAt])
  @@map("point_usage")
}
